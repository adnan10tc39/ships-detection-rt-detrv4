flowchart LR
  %% Inputs
  subgraph Inputs
    IMG["Input image"]
    TXT["Class names + prompt templates"]
  end

  %% Visual pipeline
  subgraph Visual_Pipeline
    AUG["Augment / resize / normalize"]
    BB["HGNetv2 backbone"]
    ENC["Hybrid encoder"]
    DEC["DFINE transformer decoder"]
    Q["Query features"]
    EMB["Text projection head"]
    VEMB["Visual embeddings (D)"]
  end

  IMG --> AUG --> BB --> ENC --> DEC --> Q --> EMB --> VEMB

  %% Text side
  subgraph Text_Side
    CLIP["CLIP text encoder (frozen)"]
    TEMB["Text embeddings (D)"]
  end

  TXT --> CLIP --> TEMB

  %% Heads + postprocess
  SIM["Similarity (cosine/dot + logit scale)"]
  CLS["Open-vocab logits"]
  BOX["Box regression head"]
  POST["Postprocessor"]
  OUT["Final detections"]

  VEMB --> SIM
  TEMB --> SIM
  SIM --> CLS
  DEC --> BOX
  CLS --> POST
  BOX --> POST
  POST --> OUT

  %% Training-only distillation
  subgraph Distillation_(training_only)
    DN["Normalize + avg pool"]
    TV["DINOv3 teacher (frozen)"]
    TF["Teacher features"]
    SF["Student encoder features"]
    DL["Distillation loss"]
  end

  IMG --> DN --> TV --> TF --> DL
  ENC --> SF --> DL

  %% Losses + optimization
  subgraph Losses_and_Optimization
    LCLS["MAL / VFL (classification)"]
    LBOX["L1 + GIoU (boxes)"]
    LLOC["FGL + DDF (localization)"]
    LTXT["Text alignment"]
    LDIST["Distillation"]
    SUM["Weighted sum"]
    OPT["Optimizer (Lion + AMP + EMA)"]
  end

  CLS --> LCLS --> SUM
  BOX --> LBOX --> SUM
  BOX --> LLOC --> SUM
  VEMB --> LTXT --> SUM
  DL --> LDIST --> SUM
  SUM --> OPT --> BB

